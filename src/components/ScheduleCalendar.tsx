'use client';

import React, { useState, useEffect } from 'react';
import { Card } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Textarea } from '@/components/ui/textarea';
import { ChevronLeft, ChevronRight, Plus, X, User, AlertTriangle } from 'lucide-react';
import { User as UserType, Schedule } from '@/types';
import { engineers } from '@/components/data/engineerData';
import { 
  addSchedule, 
  getSchedules, 
  updateSchedule, 
  getEngineers
} from '@/lib/firestore';

interface ScheduleCalendarProps {
  currentUser: UserType;
  engineerFilter?: string | null;
}

export default function ScheduleCalendar({ engineerFilter }: ScheduleCalendarProps) {
  const [view, setView] = useState<'month' | 'week' | 'day' | 'list'>('week');
  const [currentDate, setCurrentDate] = useState(new Date());
  const [isNewScheduleOpen, setIsNewScheduleOpen] = useState(false);
  const [schedulesList, setSchedulesList] = useState<Schedule[]>([]);
  const [conflictAlert, setConflictAlert] = useState<string | null>(null);
  const [recommendedEngineers, setRecommendedEngineers] = useState<typeof engineers>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  
  // „Ç®„É≥„Ç∏„Éã„Ç¢„Éá„Éº„ÇøÔºàFirebase„Åã„ÇâÂèñÂæóÔºâ
  const [firebaseEngineers, setFirebaseEngineers] = useState<typeof engineers>([]);
  
  // „Çπ„Ç±„Ç∏„É•„Éº„É´Ë©≥Á¥∞Ë°®Á§∫
  const [isScheduleDetailsOpen, setIsScheduleDetailsOpen] = useState(false);
  const [selectedSchedule, setSelectedSchedule] = useState<Schedule | null>(null);
  
  // „Çπ„Ç±„Ç∏„É•„Éº„É´Á∑®ÈõÜ
  const [isEditScheduleOpen, setIsEditScheduleOpen] = useState(false);
  const [editSchedule, setEditSchedule] = useState<Schedule | null>(null);

  const [newSchedule, setNewSchedule] = useState({
    title: '',
    description: '',
    engineerId: '',
    startDate: '',
    endDate: '',
    startTime: '',
    endTime: '',
    status: 'scheduled',
    priority: 'medium',
    estimatedDuration: '',
    location: '',
    customerName: '',
    customerPhone: ''
  });

  // Firebase„Åã„Çâ„Éá„Éº„Çø„ÇíÂèñÂæó
  useEffect(() => {
    const fetchData = async () => {
      try {
        setLoading(true);
        setError(null);
        
        console.log('üìÖ „Éá„Éº„Çø‰∏ÄË¶ß„ÇíÂèñÂæó‰∏≠...');
        
        // „Ç®„É≥„Ç∏„Éã„Ç¢„Éá„Éº„Çø„ÇíÂèñÂæó
        const firestoreEngineers = await getEngineers();
        console.log('üë®‚Äçüíª ÂèñÂæó„Åó„ÅüFirestore„Ç®„É≥„Ç∏„Éã„Ç¢:', firestoreEngineers);
        
        const convertedEngineers = firestoreEngineers.map((firestoreEngineer) => ({
          id: firestoreEngineer.id as string, // Firebase„ÅÆID„Çí„Åù„ÅÆ„Åæ„Åæ‰ΩøÁî®
          name: firestoreEngineer.name as string,
          email: firestoreEngineer.email as string,
          phone: (firestoreEngineer.phone as string) || '',
          departmentId: parseInt(firestoreEngineer.companyId as string) || 1,
          skills: firestoreEngineer.skills as string[],
          status: firestoreEngineer.status as 'active' | 'inactive',
          totalProjects: 0, // Âæå„ÅßË®àÁÆó
          completedProjects: 0, // Âæå„ÅßË®àÁÆó
          createdAt: firestoreEngineer.createdAt as Date,
          updatedAt: firestoreEngineer.updatedAt as Date,
        }));
        setFirebaseEngineers(convertedEngineers);
        
        // „Çπ„Ç±„Ç∏„É•„Éº„É´„Éá„Éº„Çø„ÇíÂèñÂæó
        const firestoreSchedules = await getSchedules();
        console.log('üìÖ ÂèñÂæó„Åó„ÅüFirestore„Çπ„Ç±„Ç∏„É•„Éº„É´:', firestoreSchedules);
        
        // FirestoreSchedule„ÇíScheduleÂûã„Å´Â§âÊèõ
        const convertedSchedules: Schedule[] = firestoreSchedules.map(firestoreSchedule => ({
          id: parseInt(firestoreSchedule.id) || 0, // Êï∞ÂÄ§ID„Å´Â§âÊèõÔºàÊó¢Â≠ò„ÅÆUI„Å®„ÅÆ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÔºâ
          title: firestoreSchedule.title,
          description: firestoreSchedule.description,
          engineerId: firestoreSchedule.engineerId || '', // ÊñáÂ≠óÂàóID„Çí„Åù„ÅÆ„Åæ„Åæ‰ΩøÁî®
          engineerName: firestoreSchedule.engineerName || '',
          startDate: firestoreSchedule.startTime.toISOString(),
          endDate: firestoreSchedule.endTime.toISOString(),
          status: firestoreSchedule.status,
          priority: firestoreSchedule.priority || 'medium',
          workOrderId: parseInt(firestoreSchedule.workOrderId || '0') || 0,
          location: firestoreSchedule.location,
          customerName: '',
          customerPhone: '',
          // Firebase„ÅÆÂÆüÈöõ„ÅÆ„Éâ„Ç≠„É•„É°„É≥„ÉàID„Çí‰øùÊåÅ
          firebaseId: firestoreSchedule.id
        }));
        
        console.log('üìÖ Â§âÊèõÂæå„ÅÆ„Çπ„Ç±„Ç∏„É•„Éº„É´„Éá„Éº„Çø:', convertedSchedules);
        setSchedulesList(convertedSchedules);
      } catch (err) {
        console.error('‚ùå „Éá„Éº„ÇøÂèñÂæó„Ç®„É©„Éº:', err);
        setError(`„Éá„Éº„Çø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${err instanceof Error ? err.message : 'Unknown error'}`);
      } finally {
        setLoading(false);
      }
    };

    fetchData();
  }, []);

  // ÁèæÂú®„ÅÆÊúà„ÅÆ„Ç´„É¨„É≥„ÉÄ„Éº„Éá„Éº„Çø„ÇíÁîüÊàê
  const generateCalendarDays = () => {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    const firstDay = new Date(year, month, 1);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay());
    
    const days: Array<{ date: Date; isCurrentMonth: boolean; isToday: boolean }> = [];
    const current = new Date(startDate);
    
    for (let i = 0; i < 42; i++) {
      const daySchedules = schedulesList.filter(schedule => {
        const scheduleDate = new Date(schedule.startDate);
        return scheduleDate.toDateString() === current.toDateString() &&
               (!engineerFilter || schedule.engineerId === engineerFilter);
      });
      
      days.push({
        date: current.getDate(),
        isCurrentMonth: current.getMonth() === month,
        isToday: current.toDateString() === new Date().toDateString(),
        fullDate: new Date(current),
        schedules: daySchedules.map(schedule => ({
          ...schedule,
          engineerName: firebaseEngineers.find(e => e.id === schedule.engineerId)?.name || '‰∏çÊòé',
          startTime: new Date(schedule.startDate).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }),
        }))
      });
      
      current.setDate(current.getDate() + 1);
    }
    
    return days;
  };

  // „Çπ„Ç±„Ç∏„É•„Éº„É´ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ
  const checkScheduleConflict = (engineerId: string, startDateTime: Date, endDateTime: Date) => {
    const conflicts = schedulesList.filter(schedule => {
      if (schedule.engineerId !== engineerId) return false;
      
      const existingStart = new Date(schedule.startDate);
      const existingEnd = new Date(schedule.endDate);
      
      return (startDateTime < existingEnd && endDateTime > existingStart);
    });
    
    return conflicts;
  };

  // Êñ∞Ë¶è„Çπ„Ç±„Ç∏„É•„Éº„É´‰ΩúÊàê
  const handleCreateSchedule = async () => {
    try {
      if (!newSchedule.engineerId || !newSchedule.startDate || !newSchedule.startTime) {
        setConflictAlert('ÂøÖÈ†àÈ†ÖÁõÆ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
      }

      const startDateTime = new Date(`${newSchedule.startDate}T${newSchedule.startTime}`);
      const endDateTime = new Date(`${newSchedule.endDate || newSchedule.startDate}T${newSchedule.endTime || newSchedule.startTime}`);
      
      const conflicts = checkScheduleConflict(newSchedule.engineerId, startDateTime, endDateTime);
      
      if (conflicts.length > 0) {
        const engineerName = firebaseEngineers.find(e => e.id === newSchedule.engineerId)?.name;
        setConflictAlert(`${engineerName}„Ç®„É≥„Ç∏„Éã„Ç¢„ÅÆ„Çπ„Ç±„Ç∏„É•„Éº„É´„ÅåÈáçË§á„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇÊôÇÈñì„ÇíË™øÊï¥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
        return;
      }

      setLoading(true);
      setError(null);

      // Firestore„Å´‰øùÂ≠ò„Åô„Çã„Çπ„Ç±„Ç∏„É•„Éº„É´„Éá„Éº„Çø„Çí‰ΩúÊàê
      const scheduleData = {
        title: newSchedule.title,
        description: newSchedule.description,
        startTime: startDateTime,
        endTime: endDateTime,
        engineerId: newSchedule.engineerId,
        engineerName: firebaseEngineers.find(e => e.id === newSchedule.engineerId)?.name || '',
        workOrderId: '', // ‰ΩúÊ•≠ÊåáÁ§∫ID„ÅØÂæå„ÅßË®≠ÂÆö
        status: newSchedule.status as 'scheduled' | 'in_progress' | 'completed' | 'cancelled',
        location: newSchedule.location,
        createdAt: new Date(),
        updatedAt: new Date(),
      };

      console.log('üìÖ Êñ∞Ë¶è„Çπ„Ç±„Ç∏„É•„Éº„É´ËøΩÂä†„Éá„Éº„Çø:', scheduleData);

      // Firestore„Å´„Çπ„Ç±„Ç∏„É•„Éº„É´„ÇíËøΩÂä†
      const newScheduleId = await addSchedule(scheduleData);
      console.log('‚úÖ Êñ∞„Åó„ÅÑ„Çπ„Ç±„Ç∏„É•„Éº„É´„ÅåËøΩÂä†„Åï„Çå„Åæ„Åó„Åü, ID:', newScheduleId);

      // „Çπ„Ç±„Ç∏„É•„Éº„É´‰∏ÄË¶ß„ÇíÂÜçÂèñÂæó
      const updatedFirestoreSchedules = await getSchedules();
      const updatedConvertedSchedules: Schedule[] = updatedFirestoreSchedules.map(firestoreSchedule => ({
        id: parseInt(firestoreSchedule.id) || 0,
        title: firestoreSchedule.title,
        description: firestoreSchedule.description,
          engineerId: firestoreSchedule.engineerId || '',
        engineerName: firestoreSchedule.engineerName || '',
        startDate: firestoreSchedule.startTime.toISOString(),
        endDate: firestoreSchedule.endTime.toISOString(),
        status: firestoreSchedule.status,
        priority: firestoreSchedule.priority || 'medium',
        workOrderId: parseInt(firestoreSchedule.workOrderId || '0') || 0,
        location: firestoreSchedule.location,
        customerName: '',
        customerPhone: '',
        firebaseId: firestoreSchedule.id
      }));
      
      setSchedulesList(updatedConvertedSchedules);
      setIsNewScheduleOpen(false);
      setConflictAlert(null);
      setRecommendedEngineers([]);
      setNewSchedule({
        title: '',
        description: '',
        engineerId: '',
        startDate: '',
        endDate: '',
        startTime: '',
        endTime: '',
        status: 'scheduled',
        priority: 'medium',
        estimatedDuration: '',
        location: '',
        customerName: '',
        customerPhone: ''
      });
    } catch (err) {
      console.error('‚ùå „Çπ„Ç±„Ç∏„É•„Éº„É´ËøΩÂä†„Ç®„É©„Éº:', err);
      setError(`„Çπ„Ç±„Ç∏„É•„Éº„É´„ÅÆËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${err instanceof Error ? err.message : 'Unknown error'}`);
    } finally {
      setLoading(false);
    }
  };

  const calendarDays = generateCalendarDays();
  const filteredEngineer = engineerFilter ? firebaseEngineers.find(e => e.id === engineerFilter) : null;

  // ÈÄ±ÈñìË°®Á§∫Áî®„ÅÆ„Éá„Éº„ÇøÁîüÊàê
  const generateWeekData = () => {
    const startOfWeek = new Date(currentDate);
    const day = startOfWeek.getDay();
    startOfWeek.setDate(startOfWeek.getDate() - day);
    
    const weekDays: Array<{ date: Date; dayName: string; isToday: boolean }> = [];
    for (let i = 0; i < 7; i++) {
      const date = new Date(startOfWeek);
      date.setDate(startOfWeek.getDate() + i);
      const dayName = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'][i];
      const isToday = date.toDateString() === new Date().toDateString();
      weekDays.push({ date, dayName, isToday });
    }
    
    return weekDays;
  };

  // Êó•ÈñìË°®Á§∫Áî®„ÅÆ„Éá„Éº„ÇøÁîüÊàêÔºà24ÊôÇÈñìÔºâ
  const generateDayData = () => {
    const hours: number[] = [];
    for (let i = 0; i < 24; i++) {
      hours.push(i);
    }
    return hours;
  };

  // „Çπ„Ç±„Ç∏„É•„Éº„É´„ÇíÊôÇÈñìÂà•„Å´ÂèñÂæó
  const getSchedulesForDate = (date: Date) => {
    return schedulesList.filter(schedule => {
      const scheduleDate = new Date(schedule.startDate);
      return scheduleDate.toDateString() === date.toDateString() &&
             (!engineerFilter || schedule.engineerId === engineerFilter);
    });
  };

  // „Çπ„Ç±„Ç∏„É•„Éº„É´„ÇíÊôÇÈñìÂà•„Å´ÂèñÂæó
  const getSchedulesForHour = (date: Date, hour: number) => {
    return schedulesList.filter(schedule => {
      const scheduleDate = new Date(schedule.startDate);
      const scheduleHour = scheduleDate.getHours();
      return scheduleDate.toDateString() === date.toDateString() &&
             scheduleHour === hour &&
             (!engineerFilter || schedule.engineerId === engineerFilter);
    });
  };

  // Êé®Â•®„Ç®„É≥„Ç∏„Éã„Ç¢„ÇíÂèñÂæóÔºàË©≤ÂΩìÊó•ÊôÇ„ÅÆÁ®ºÂÉçÁä∂Ê≥Å„ÇíÂãïÁöÑ„ÉÅ„Çß„ÉÉ„ÇØÔºâ
  const getRecommendedEngineers = (date: string, startTime?: string, endTime?: string) => {
    if (!date) {
      setRecommendedEngineers([]);
      return;
    }

    // Ë©≤ÂΩìÊó•ÊôÇ„ÅÆ„Çπ„Ç±„Ç∏„É•„Éº„É´ÊôÇÈñì„ÇíË®àÁÆó
    const scheduleStartTime = startTime || '09:00';
    const scheduleEndTime = endTime || '18:00';
    const scheduleStartDateTime = new Date(`${date}T${scheduleStartTime}`);
    const scheduleEndDateTime = new Date(`${date}T${scheduleEndTime}`);

    console.log('üîç Êé®Â•®„Ç®„É≥„Ç∏„Éã„Ç¢Ê§úÁ¥¢:', { 
      date, 
      startTime: scheduleStartTime, 
      endTime: scheduleEndTime,
      scheduleStartDateTime,
      scheduleEndDateTime
    });

    // ÂêÑ„Ç®„É≥„Ç∏„Éã„Ç¢„ÅÆË©≤ÂΩìÊó•ÊôÇ„ÅÆÁ®ºÂÉçÁä∂Ê≥Å„Çí„ÉÅ„Çß„ÉÉ„ÇØ
    const engineersWithAvailability = firebaseEngineers.map(engineer => {
      // Ë©≤ÂΩì„Ç®„É≥„Ç∏„Éã„Ç¢„ÅÆË©≤ÂΩìÊó•ÊôÇ„ÅÆ„Çπ„Ç±„Ç∏„É•„Éº„É´„ÇíÂèñÂæó
      const engineerSchedules = schedulesList.filter(schedule => {
        if (schedule.engineerId !== engineer.id) return false;
        
        const scheduleDate = new Date(schedule.startDate);
        const scheduleEndDate = new Date(schedule.endDate);
        
        // Âêå„ÅòÊó•‰ªò„ÅÆ„Çπ„Ç±„Ç∏„É•„Éº„É´„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        return scheduleDate.toDateString() === scheduleStartDateTime.toDateString() ||
               scheduleEndDate.toDateString() === scheduleStartDateTime.toDateString();
      });

      // ÊôÇÈñìÈáçË§á„Çí„ÉÅ„Çß„ÉÉ„ÇØ
      const hasConflict = engineerSchedules.some(schedule => {
        const existingStart = new Date(schedule.startDate);
        const existingEnd = new Date(schedule.endDate);
        
        // ÊôÇÈñì„ÅåÈáçË§á„Åó„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        return (scheduleStartDateTime < existingEnd && scheduleEndDateTime > existingStart);
      });

      // Á®ºÂÉçÁä∂Ê≥Å„ÇíÊ±∫ÂÆöÔºàÊôÇÈñìÁØÑÂõ≤„Åß„ÅÆÈáçË§á„ÅÆ„Åø„Çí„ÉÅ„Çß„ÉÉ„ÇØÔºâ
      let availabilityStatus: 'available' | 'busy' | 'partial';
      if (hasConflict) {
        availabilityStatus = 'busy';
      } else {
        availabilityStatus = 'available'; // ÊôÇÈñìÈáçË§á„Åå„Å™„Åë„Çå„Å∞Á©∫„Åç„ÅÇ„Çä
      }

      return {
        ...engineer,
        availabilityStatus,
        conflictCount: engineerSchedules.length
      };
    });

    // Á®ºÂÉçÁä∂Ê≥Å„Å´Âü∫„Å•„ÅÑ„Å¶„ÇΩ„Éº„ÉàÔºàÁ©∫„ÅÑ„Å¶„ÅÑ„Çã„Ç®„É≥„Ç∏„Éã„Ç¢„ÇíÂÑ™ÂÖàÔºâ
    const sortedEngineers = engineersWithAvailability.sort((a, b) => {
      const statusPriority = { 'available': 0, 'partial': 1, 'busy': 2 };
      const aPriority = statusPriority[a.availabilityStatus];
      const bPriority = statusPriority[b.availabilityStatus];
      
      if (aPriority !== bPriority) {
        return aPriority - bPriority;
      }
      
      // Âêå„ÅòÁ®ºÂÉçÁä∂Ê≥Å„ÅÆÂ†¥Âêà„ÅØ„ÄÅ„Çπ„Ç±„Ç∏„É•„Éº„É´Êï∞„ÅåÂ∞ë„Å™„ÅÑÊñπ„ÇíÂÑ™ÂÖà
      return a.conflictCount - b.conflictCount;
    });

    console.log('üîç Êé®Â•®„Ç®„É≥„Ç∏„Éã„Ç¢ÁµêÊûú:', sortedEngineers);
    setRecommendedEngineers(sortedEngineers.slice(0, 3)); // ‰∏ä‰Ωç3Âêç„Çí„É¨„Ç≥„É°„É≥„Éâ
  };

  const navigateMonth = (direction: 'prev' | 'next') => {
    const newDate = new Date(currentDate);
    if (view === 'week') {
      // ÈÄ±ÈñìË°®Á§∫„ÅÆÂ†¥Âêà„ÅØ7Êó•„Åö„Å§ÁßªÂãï
      newDate.setDate(newDate.getDate() + (direction === 'next' ? 7 : -7));
    } else if (view === 'day') {
      // Êó•ÈñìË°®Á§∫„ÅÆÂ†¥Âêà„ÅØ1Êó•„Åö„Å§ÁßªÂãï
      newDate.setDate(newDate.getDate() + (direction === 'next' ? 1 : -1));
    } else {
      // ÊúàÈñìË°®Á§∫„ÅÆÂ†¥Âêà„ÅØ1„É∂Êúà„Åö„Å§ÁßªÂãï
      newDate.setMonth(newDate.getMonth() + (direction === 'next' ? 1 : -1));
    }
    setCurrentDate(newDate);
  };

  const clearFilter = () => {
    // Ë¶™„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„Å´„Éï„Ç£„É´„Çø„Éº„ÇØ„É™„Ç¢„ÇíÈÄöÁü•
    window.location.reload(); // Á∞°ÊòìÂÆüË£Ö
  };

  const openNewScheduleDialog = (day: { date: number; isCurrentMonth: boolean; isToday: boolean; fullDate: Date; schedules: Array<{ id: number; title: string; engineerName: string; startTime: string; status: string }> }) => {
    setNewSchedule({
      ...newSchedule,
      startDate: day.fullDate.toISOString().split('T')[0],
      endDate: day.fullDate.toISOString().split('T')[0]
    });
    setIsNewScheduleOpen(true);
    getRecommendedEngineers(day.fullDate.toISOString().split('T')[0], newSchedule.startTime, newSchedule.endTime);
  };

  // ÈñãÂßãÊó•„ÅÆÂ§âÊõ¥„Éè„É≥„Éâ„É©„Éº
  const handleStartDateChange = (startDate: string) => {
    setNewSchedule({...newSchedule, startDate});
    if (startDate) {
      getRecommendedEngineers(startDate, newSchedule.startTime, newSchedule.endTime);
    }
  };

  // ÈñãÂßãÊôÇÈñì„ÅÆÂ§âÊõ¥„Éè„É≥„Éâ„É©„Éº
  const handleStartTimeChange = (startTime: string) => {
    setNewSchedule({...newSchedule, startTime});
    if (newSchedule.startDate) {
      getRecommendedEngineers(newSchedule.startDate, startTime, newSchedule.endTime);
    }
  };

  // ÁµÇ‰∫ÜÊó•„ÅÆÂ§âÊõ¥„Éè„É≥„Éâ„É©„Éº
  const handleEndDateChange = (endDate: string) => {
    setNewSchedule({...newSchedule, endDate});
    if (endDate) {
      getRecommendedEngineers(endDate, newSchedule.startTime, newSchedule.endTime);
    }
  };

  // ÁµÇ‰∫ÜÊôÇÈñì„ÅÆÂ§âÊõ¥„Éè„É≥„Éâ„É©„Éº
  const handleEndTimeChange = (endTime: string) => {
    setNewSchedule({...newSchedule, endTime});
    if (newSchedule.startDate) {
      getRecommendedEngineers(newSchedule.startDate, newSchedule.startTime, endTime);
    }
  };

  const openScheduleDetails = (schedule: Schedule) => {
    console.log('„Çπ„Ç±„Ç∏„É•„Éº„É´Ë©≥Á¥∞:', schedule);
    setSelectedSchedule(schedule);
    setIsScheduleDetailsOpen(true);
  };

  const openEditSchedule = (schedule: Schedule) => {
    console.log('„Çπ„Ç±„Ç∏„É•„Éº„É´Á∑®ÈõÜ:', schedule);
    setEditSchedule(schedule);
    setIsEditScheduleOpen(true);
  };

  const handleUpdateSchedule = async () => {
    if (!editSchedule) return;

    try {
      setLoading(true);
      setError(null);

      // Firebase„ÅÆÂÆüÈöõ„ÅÆ„Éâ„Ç≠„É•„É°„É≥„ÉàID„Çí‰ΩøÁî®
      const scheduleId = editSchedule.firebaseId || editSchedule.id.toString();
      
      if (!scheduleId || scheduleId === '0') {
        throw new Error('„Çπ„Ç±„Ç∏„É•„Éº„É´ID„ÅåÁÑ°Âäπ„Åß„Åô');
      }
      
      console.log('üìÖ „Çπ„Ç±„Ç∏„É•„Éº„É´Êõ¥Êñ∞„Éá„Éº„Çø:', { 
        originalId: editSchedule.id, 
        scheduleId, 
        editSchedule 
      });
      
      const updateData = {
        title: editSchedule.title,
        description: editSchedule.description,
        engineerId: editSchedule.engineerId.toString(),
        engineerName: editSchedule.engineerName,
        startTime: new Date(editSchedule.startDate),
        endTime: new Date(editSchedule.endDate),
        status: editSchedule.status,
        location: editSchedule.location,
        updatedAt: new Date(),
      };

      // Firestore„ÅÆ„Çπ„Ç±„Ç∏„É•„Éº„É´„ÇíÊõ¥Êñ∞
      await updateSchedule(scheduleId, updateData);
      console.log('‚úÖ „Çπ„Ç±„Ç∏„É•„Éº„É´„ÅåÊõ¥Êñ∞„Åï„Çå„Åæ„Åó„Åü');

      // „Çπ„Ç±„Ç∏„É•„Éº„É´‰∏ÄË¶ß„ÇíÂÜçÂèñÂæó
      const updatedFirestoreSchedules = await getSchedules();
      const updatedConvertedSchedules: Schedule[] = updatedFirestoreSchedules.map(firestoreSchedule => ({
        id: parseInt(firestoreSchedule.id) || 0,
        title: firestoreSchedule.title,
        description: firestoreSchedule.description,
          engineerId: firestoreSchedule.engineerId || '',
        engineerName: firestoreSchedule.engineerName || '',
        startDate: firestoreSchedule.startTime.toISOString(),
        endDate: firestoreSchedule.endTime.toISOString(),
        status: firestoreSchedule.status,
        priority: firestoreSchedule.priority || 'medium',
        workOrderId: parseInt(firestoreSchedule.workOrderId || '0') || 0,
        location: firestoreSchedule.location,
        customerName: '',
        customerPhone: '',
        firebaseId: firestoreSchedule.id
      }));
      
      setSchedulesList(updatedConvertedSchedules);
      setIsEditScheduleOpen(false);
      setEditSchedule(null);
    } catch (err) {
      console.error('‚ùå „Çπ„Ç±„Ç∏„É•„Éº„É´Êõ¥Êñ∞„Ç®„É©„Éº:', err);
      setError(`„Çπ„Ç±„Ç∏„É•„Éº„É´„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${err instanceof Error ? err.message : 'Unknown error'}`);
    } finally {
      setLoading(false);
    }
  };

  // „É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖã
  if (loading && schedulesList.length === 0) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="text-center">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4"></div>
          <p className="text-muted-foreground">„Çπ„Ç±„Ç∏„É•„Éº„É´„ÇíË™≠„ÅøËæº„Åø‰∏≠...</p>
        </div>
      </div>
    );
  }

  // „Ç®„É©„ÉºÁä∂ÊÖã
  if (error) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="text-center">
          <AlertTriangle className="h-8 w-8 text-destructive mx-auto mb-4" />
          <p className="text-destructive mb-4">{error}</p>
          <Button onClick={() => window.location.reload()}>
            ÂÜçË™≠„ÅøËæº„Åø
          </Button>
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* „Ç´„É¨„É≥„ÉÄ„Éº„Ç≥„É≥„Éà„É≠„Éº„É´„Éê„Éº */}
      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div className="flex items-center gap-4">
          <h1 className="text-2xl font-semibold">„Çπ„Ç±„Ç∏„É•„Éº„É´</h1>
          {/* ÊúàÊ¨°„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ */}
          <div className="flex items-center gap-2">
            <Button variant="outline" size="sm" onClick={() => navigateMonth('prev')}>
              <ChevronLeft className="w-4 h-4" />
            </Button>
            <span className="text-lg font-medium min-w-32 text-center">
              {currentDate.getFullYear()}Âπ¥{currentDate.getMonth() + 1}Êúà
            </span>
            <Button variant="outline" size="sm" onClick={() => navigateMonth('next')}>
              <ChevronRight className="w-4 h-4" />
            </Button>
          </div>
        </div>
        
        <div className="flex items-center gap-2">
          {/* „Ç®„É≥„Ç∏„Éã„Ç¢„Éï„Ç£„É´„Çø„Éº */}
          {engineerFilter && filteredEngineer && (
            <Badge variant="secondary" className="gap-2">
              <User className="w-3 h-3" />
              {filteredEngineer.name}
              <Button variant="ghost" size="sm" className="h-auto p-0" onClick={clearFilter}>
                <X className="w-3 h-3" />
              </Button>
            </Badge>
          )}
          
          {/* Ë°®Á§∫Âàá„ÇäÊõø„Åà */}
          <div className="flex border rounded-lg">
            <Button 
              variant={view === 'month' ? 'default' : 'ghost'} 
              size="sm" 
              className="rounded-r-none"
              onClick={() => setView('month')}
            >
              ÊúàÈñì
            </Button>
            <Button 
              variant={view === 'week' ? 'default' : 'ghost'} 
              size="sm" 
              className="rounded-none border-x-0"
              onClick={() => setView('week')}
            >
              ÈÄ±Èñì
            </Button>
            <Button 
              variant={view === 'day' ? 'default' : 'ghost'} 
              size="sm" 
              className="rounded-none border-x-0"
              onClick={() => setView('day')}
            >
              Êó•Èñì
            </Button>
          </div>
          
          <Dialog open={isNewScheduleOpen} onOpenChange={setIsNewScheduleOpen}>
            <DialogTrigger asChild>
              <Button size="sm">
                <Plus className="w-4 h-4 mr-2" />
                Êñ∞Ë¶è„Çπ„Ç±„Ç∏„É•„Éº„É´
              </Button>
            </DialogTrigger>
            <DialogContent className="sm:max-w-[500px]">
              <DialogHeader>
                <DialogTitle>Êñ∞Ë¶è„Çπ„Ç±„Ç∏„É•„Éº„É´</DialogTitle>
              </DialogHeader>
              <div className="grid gap-4 py-4">
                {conflictAlert && (
                  <div className="flex items-center gap-2 p-3 bg-orange-100 border border-orange-200 rounded-lg">
                    <AlertTriangle className="w-4 h-4 text-orange-600" />
                    <span className="text-sm text-orange-800">{conflictAlert}</span>
                  </div>
                )}
                <div className="grid gap-2">
                  <Label htmlFor="title">„Çø„Ç§„Éà„É´</Label>
                  <Input
                    id="title"
                    value={newSchedule.title}
                    onChange={(e) => setNewSchedule({...newSchedule, title: e.target.value})}
                    placeholder="„Çπ„Ç±„Ç∏„É•„Éº„É´„Çø„Ç§„Éà„É´"
                  />
                </div>
                <div className="grid gap-2">
                  <Label htmlFor="description">Ë©≥Á¥∞</Label>
                  <Textarea
                    id="description"
                    value={newSchedule.description}
                    onChange={(e) => setNewSchedule({...newSchedule, description: e.target.value})}
                    placeholder="„Çπ„Ç±„Ç∏„É•„Éº„É´Ë©≥Á¥∞"
                    rows={3}
                  />
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div className="grid gap-2">
                    <Label htmlFor="engineer">ÊãÖÂΩì„Ç®„É≥„Ç∏„Éã„Ç¢</Label>
                    <Select value={newSchedule.engineerId} onValueChange={(value) => setNewSchedule({...newSchedule, engineerId: value})}>
                      <SelectTrigger>
                        <SelectValue placeholder="„Ç®„É≥„Ç∏„Éã„Ç¢„ÇíÈÅ∏Êäû" />
                      </SelectTrigger>
                      <SelectContent>
                        {firebaseEngineers.map(engineer => (
                          <SelectItem key={engineer.id} value={engineer.id.toString()}>
                            {engineer.name}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>
                  <div className="grid gap-2">
                    <Label htmlFor="priority">ÂÑ™ÂÖàÂ∫¶</Label>
                    <Select value={newSchedule.priority} onValueChange={(value) => setNewSchedule({...newSchedule, priority: value})}>
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="low">‰Ωé</SelectItem>
                        <SelectItem value="medium">‰∏≠</SelectItem>
                        <SelectItem value="high">È´ò</SelectItem>
                        <SelectItem value="urgent">Á∑äÊÄ•</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div className="grid gap-2">
                    <Label htmlFor="startDate">ÈñãÂßãÊó•</Label>
                    <Input
                      id="startDate"
                      type="date"
                      value={newSchedule.startDate}
                      onChange={(e) => handleStartDateChange(e.target.value)}
                    />
                  </div>
                  <div className="grid gap-2">
                    <Label htmlFor="endDate">ÁµÇ‰∫ÜÊó•</Label>
                    <Input
                      id="endDate"
                      type="date"
                      value={newSchedule.endDate}
                      onChange={(e) => handleEndDateChange(e.target.value)}
                    />
                  </div>
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div className="grid gap-2">
                    <Label htmlFor="startTime">ÈñãÂßãÊôÇÈñì</Label>
                    <Input
                      id="startTime"
                      type="time"
                      value={newSchedule.startTime}
                      onChange={(e) => handleStartTimeChange(e.target.value)}
                    />
                  </div>
                  <div className="grid gap-2">
                    <Label htmlFor="endTime">ÁµÇ‰∫ÜÊôÇÈñì</Label>
                    <Input
                      id="endTime"
                      type="time"
                      value={newSchedule.endTime}
                      onChange={(e) => handleEndTimeChange(e.target.value)}
                    />
                  </div>
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div className="grid gap-2">
                    <Label htmlFor="estimatedDuration">‰∫àÊÉ≥ÊôÇÈñìÔºàÂàÜÔºâ</Label>
                    <Input
                      id="estimatedDuration"
                      type="number"
                      value={newSchedule.estimatedDuration}
                      onChange={(e) => setNewSchedule({...newSchedule, estimatedDuration: e.target.value})}
                      placeholder="60"
                    />
                  </div>
                  <div className="grid gap-2">
                    <Label htmlFor="location">Â†¥ÊâÄ</Label>
                    <Input
                      id="location"
                      value={newSchedule.location}
                      onChange={(e) => setNewSchedule({...newSchedule, location: e.target.value})}
                      placeholder="‰ΩúÊ•≠Â†¥ÊâÄ"
                    />
                  </div>
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div className="grid gap-2">
                    <Label htmlFor="customerName">È°ßÂÆ¢Âêç</Label>
                    <Input
                      id="customerName"
                      value={newSchedule.customerName}
                      onChange={(e) => setNewSchedule({...newSchedule, customerName: e.target.value})}
                      placeholder="È°ßÂÆ¢Âêç"
                    />
                  </div>
                  <div className="grid gap-2">
                    <Label htmlFor="customerPhone">È°ßÂÆ¢ÈõªË©±</Label>
                    <Input
                      id="customerPhone"
                      value={newSchedule.customerPhone}
                      onChange={(e) => setNewSchedule({...newSchedule, customerPhone: e.target.value})}
                      placeholder="090-1234-5678"
                    />
                  </div>
                </div>
                
                {/* Êé®Â•®„Ç®„É≥„Ç∏„Éã„Ç¢Ë°®Á§∫ */}
                {recommendedEngineers.length > 0 && (
                  <div className="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <h4 className="text-sm font-medium text-blue-900 mb-2">
                      Êé®Â•®„Ç®„É≥„Ç∏„Éã„Ç¢Ôºà{newSchedule.startDate} {newSchedule.startTime || '09:00'} - {newSchedule.endTime || '18:00'}Ôºâ
                    </h4>
                    <div className="space-y-2">
                      {recommendedEngineers.map((engineer: Engineer) => (
                        <div key={engineer.id} className="flex items-center justify-between p-2 bg-white rounded border">
                          <div>
                            <span className="font-medium text-sm">{engineer.name}</span>
                            <span className="text-xs text-gray-500 ml-2">
                              {engineer.departmentId === 1 ? 'ÊäÄË°ìÈÉ®' : '‰øùÂÆàÈÉ®'}
                            </span>
                            {engineer.conflictCount > 0 && (
                              <span className="text-xs text-orange-600 ml-2">
                                Ôºà{engineer.conflictCount}‰ª∂„ÅÆ‰∫àÂÆö„ÅÇ„ÇäÔºâ
                              </span>
                            )}
                          </div>
                          <Badge className={
                            engineer.availabilityStatus === 'available' ? 'bg-green-100 text-green-700' :
                            engineer.availabilityStatus === 'busy' ? 'bg-red-100 text-red-700' :
                            'bg-gray-100 text-gray-700'
                          }>
                            {engineer.availabilityStatus === 'available' ? 'Á©∫„Åç„ÅÇ„Çä' :
                             engineer.availabilityStatus === 'busy' ? 'Á®ºÂÉç‰∏≠' : '‰∏çÊòé'}
                          </Badge>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
              <div className="flex justify-end gap-2">
                <Button variant="outline" onClick={() => {
                  setIsNewScheduleOpen(false);
                  setConflictAlert(null);
                }}>
                  „Ç≠„É£„É≥„Çª„É´
                </Button>
                <Button onClick={handleCreateSchedule}>
                  ‰ΩúÊàê
                </Button>
              </div>
            </DialogContent>
          </Dialog>
        </div>
      </div>

      {/* „Ç´„É¨„É≥„ÉÄ„Éº„É°„Ç§„É≥„Ç®„É™„Ç¢ */}
      <Card className="overflow-hidden">
        
        {/* ÊúàÈñìË°®Á§∫ */}
        {view === 'month' && (
          <div className="p-0">
            {/* ÊõúÊó•„Éò„ÉÉ„ÉÄ„Éº */}
            <div className="grid grid-cols-7 border-b">
              {['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'].map(day => (
                <div key={day} className="p-4 text-center text-sm font-medium border-r last:border-r-0">
                  {day}
                </div>
              ))}
            </div>
            
            {/* „Ç´„É¨„É≥„ÉÄ„Éº„Ç∞„É™„ÉÉ„Éâ */}
            <div className="grid grid-cols-7">
              {calendarDays.map((day, index) => (
                <div 
                  key={index} 
                  className="min-h-32 p-2 border-r border-b last-in-row:border-r-0 last-row:border-b-0 cursor-pointer hover:bg-muted/50"
                  onClick={() => {
                    // ‰∫àÂÆö„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØË©≥Á¥∞Ë°®Á§∫„ÄÅ„Å™„ÅÑÂ†¥Âêà„ÅØÊñ∞Ë¶èÁôªÈå≤
                    if (day.schedules.length > 0) {
                      // ‰∫àÂÆö„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÊúÄÂàù„ÅÆ‰∫àÂÆö„ÅÆË©≥Á¥∞„ÇíË°®Á§∫
                      openScheduleDetails(day.schedules[0]);
                    } else {
                      // ‰∫àÂÆö„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÊñ∞Ë¶èÁôªÈå≤
                      openNewScheduleDialog(day);
                    }
                  }}
                >
                  {/* Êó•‰ªòÁï™Âè∑ */}
                  <div className="flex justify-between items-start mb-2">
                    <span className={`text-sm ${
                      day.isCurrentMonth ? 'text-foreground' : 'text-muted-foreground'
                    } ${day.isToday ? 'bg-primary text-primary-foreground rounded-full w-6 h-6 flex items-center justify-center' : ''}`}>
                      {day.date}
                    </span>
                    {day.schedules.length > 3 && (
                      <span className="text-xs text-muted-foreground">+{day.schedules.length - 3}</span>
                    )}
                  </div>
                  
                  {/* „Çπ„Ç±„Ç∏„É•„Éº„É´„Ç¢„Ç§„ÉÜ„É†ÔºàÊúÄÂ§ß3‰ª∂Ë°®Á§∫Ôºâ */}
                  <div className="space-y-1">
                    {day.schedules.slice(0, 3).map(schedule => (
                      <div 
                        key={schedule.id}
                        className={`text-xs p-1 rounded truncate cursor-pointer hover:opacity-80 ${
                          schedule.status === 'completed' ? 'bg-green-100 text-green-800' :
                          schedule.status === 'in_progress' ? 'bg-orange-100 text-orange-800' :
                          schedule.status === 'cancelled' ? 'bg-gray-100 text-gray-800' :
                          'bg-blue-100 text-blue-800'
                        }`}
                        onClick={(e) => {
                          e.stopPropagation();
                          openScheduleDetails(schedule);
                        }}
                      >
                        <div className="flex items-center gap-1">
                          {engineerFilter ? (
                            <span>{schedule.startTime} {schedule.title}</span>
                          ) : (
                            <span>{schedule.engineerName}: {schedule.title}</span>
                          )}
                        </div>
                      </div>
                    ))}
                    {day.schedules.length > 3 && (
                      <div className="text-xs text-muted-foreground text-center">
                        +{day.schedules.length - 3}‰ª∂
                      </div>
                    )}
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* ÈÄ±ÈñìË°®Á§∫ */}
        {view === 'week' && (
          <div className="p-0">
            <div className="grid grid-cols-8 border-b">
              <div className="p-4 text-center text-sm font-medium border-r">
                „Ç®„É≥„Ç∏„Éã„Ç¢
              </div>
              {generateWeekData().map((dayData, index) => (
                <div key={index} className="p-4 text-center text-sm font-medium border-r last:border-r-0">
                  <div>{dayData.date.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' })}</div>
                  <div className="text-xs text-muted-foreground">
                    {dayData.dayName}
                  </div>
                </div>
              ))}
            </div>
            
            <div className="grid grid-cols-8">
              {firebaseEngineers.map((engineer) => (
                <React.Fragment key={engineer.id}>
                  <div className="p-4 border-r border-b bg-muted/30">
                    <div className="font-medium text-sm">{engineer.name}</div>
                    <div className="text-xs text-muted-foreground">{engineer.departmentId === 1 ? 'ÊäÄË°ìÈÉ®' : '‰øùÂÆàÈÉ®'}</div>
                  </div>
                  {generateWeekData().map((dayData, dateIndex) => (
                    <div 
                      key={dateIndex} 
                      className="p-2 border-r border-b last:border-r-0 min-h-20 cursor-pointer hover:bg-muted/30"
                      onClick={() => {
                        // „Åù„ÅÆÊó•„ÅÆ„Çπ„Ç±„Ç∏„É•„Éº„É´„ÇíÂèñÂæó
                        const daySchedules = schedulesList.filter(schedule => {
                          const scheduleDate = new Date(schedule.startDate);
                          return scheduleDate.toDateString() === dayData.date.toDateString() && schedule.engineerId === engineer.id;
                        });
                        
                        if (daySchedules.length > 0) {
                          // ‰∫àÂÆö„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÊúÄÂàù„ÅÆ‰∫àÂÆö„ÅÆË©≥Á¥∞„ÇíË°®Á§∫
                          openScheduleDetails(daySchedules[0]);
                        } else {
                          // ‰∫àÂÆö„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÊñ∞Ë¶èÁôªÈå≤
                          openNewScheduleDialog({
                            date: dayData.date.getDate(),
                            isCurrentMonth: true,
                            isToday: dayData.isToday,
                            fullDate: dayData.date,
                            schedules: []
                          });
                        }
                      }}
                    >
                      {getSchedulesForDate(dayData.date).filter(schedule => schedule.engineerId === engineer.id).map((schedule) => (
                        <div 
                          key={schedule.id}
                          className={`text-xs p-1 rounded mb-1 cursor-pointer hover:opacity-80 ${
                            schedule.status === 'completed' ? 'bg-green-100 text-green-800' :
                            schedule.status === 'in_progress' ? 'bg-orange-100 text-orange-800' :
                            schedule.status === 'cancelled' ? 'bg-gray-100 text-gray-800' :
                            'bg-blue-100 text-blue-800'
                          }`}
                          onClick={() => openScheduleDetails(schedule)}
                        >
                          <div className="truncate">{schedule.title}</div>
                          <div className="text-xs opacity-75">
                            {new Date(schedule.startDate).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' })}
                          </div>
                        </div>
                      ))}
                    </div>
                  ))}
                </React.Fragment>
              ))}
            </div>
          </div>
        )}

        {/* Êó•ÈñìË°®Á§∫ */}
        {view === 'day' && (
          <div className="p-0">
            {/* Êó•‰ªòË°®Á§∫„Ç®„É™„Ç¢ */}
            <div className="p-4 bg-muted/30 border-b">
              <h3 className="text-lg font-semibold text-center">
                {currentDate.toLocaleDateString('ja-JP', {
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric',
                  weekday: 'long'
                })}
              </h3>
            </div>
            
            <div className="grid grid-cols-25 border-b">
              <div className="p-4 text-center text-sm font-medium border-r">
                „Ç®„É≥„Ç∏„Éã„Ç¢
              </div>
              {generateDayData().map((hour) => (
                <div key={hour} className="p-2 text-center text-xs font-medium border-r last:border-r-0">
                  {hour}:00
                </div>
              ))}
            </div>
            
            <div className="grid grid-cols-25">
              {firebaseEngineers.map((engineer) => (
                <React.Fragment key={engineer.id}>
                  <div className="p-4 border-r border-b bg-muted/30">
                    <div className="font-medium text-sm">{engineer.name}</div>
                    <div className="text-xs text-muted-foreground">{engineer.departmentId === 1 ? 'ÊäÄË°ìÈÉ®' : '‰øùÂÆàÈÉ®'}</div>
                  </div>
                  {generateDayData().map((hour) => (
                    <div 
                      key={hour} 
                      className="p-1 border-r border-b last:border-r-0 min-h-12 cursor-pointer hover:bg-muted/30"
                      onClick={() => {
                        const date = new Date(currentDate);
                        date.setHours(hour, 0, 0, 0);
                        
                        // „Åù„ÅÆÊôÇÈñì„ÅÆ„Çπ„Ç±„Ç∏„É•„Éº„É´„ÇíÂèñÂæó
                        const hourSchedules = schedulesList.filter(schedule => {
                          const scheduleDate = new Date(schedule.startDate);
                          return scheduleDate.toDateString() === date.toDateString() && 
                                 schedule.engineerId === engineer.id &&
                                 scheduleDate.getHours() === hour;
                        });
                        
                        if (hourSchedules.length > 0) {
                          // ‰∫àÂÆö„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÊúÄÂàù„ÅÆ‰∫àÂÆö„ÅÆË©≥Á¥∞„ÇíË°®Á§∫
                          openScheduleDetails(hourSchedules[0]);
                        } else {
                          // ‰∫àÂÆö„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÊñ∞Ë¶èÁôªÈå≤
                          openNewScheduleDialog({
                            date: date.getDate(),
                            isCurrentMonth: true,
                            isToday: date.toDateString() === new Date().toDateString(),
                            fullDate: date,
                            schedules: []
                          });
                        }
                      }}
                    >
                      {getSchedulesForHour(currentDate, hour).filter(schedule => schedule.engineerId === engineer.id).map((schedule) => (
                        <div 
                          key={schedule.id}
                          className={`text-xs p-1 rounded cursor-pointer hover:opacity-80 ${
                            schedule.status === 'completed' ? 'bg-green-100 text-green-800' :
                            schedule.status === 'in_progress' ? 'bg-orange-100 text-orange-800' :
                            schedule.status === 'cancelled' ? 'bg-gray-100 text-gray-800' :
                            'bg-blue-100 text-blue-800'
                          }`}
                          onClick={() => openScheduleDetails(schedule)}
                        >
                          <div className="truncate">{schedule.title}</div>
                        </div>
                      ))}
                    </div>
                  ))}
                </React.Fragment>
              ))}
            </div>
          </div>
        )}

      </Card>

      {/* ‰∫àÂÆö„É™„Çπ„ÉàË°®Á§∫ */}
      <Card>
        <div className="p-6">
          <h3 className="text-lg font-semibold mb-4">‰∫àÂÆö‰∏ÄË¶ß</h3>
          <div className="space-y-4">
            {schedulesList
              .filter(schedule => !engineerFilter || schedule.engineerId === engineerFilter)
              .sort((a, b) => new Date(a.startDate).getTime() - new Date(b.startDate).getTime())
              .map((schedule) => {
                const engineer = firebaseEngineers.find(e => e.id === schedule.engineerId);
                return (
                  <div key={schedule.id} className="flex items-center justify-between p-4 border rounded-lg hover:bg-muted/50">
                    <div className="flex items-center gap-4">
                      <div className="w-3 h-3 rounded-full bg-primary"></div>
                      <div>
                        <h3 className="font-medium">{schedule.title}</h3>
                        <p className="text-sm text-muted-foreground">{schedule.description}</p>
                      </div>
                    </div>
                    <div className="flex items-center gap-4">
                      <div className="text-right">
                        <p className="text-sm font-medium">{engineer?.name}</p>
                        <p className="text-xs text-muted-foreground">
                          {new Date(schedule.startDate).toLocaleDateString('ja-JP')} 
                          {new Date(schedule.startDate).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' })}
                        </p>
                      </div>
                      <Badge className={
                        schedule.status === 'completed' ? 'bg-green-100 text-green-700' :
                        schedule.status === 'in_progress' ? 'bg-orange-100 text-orange-700' :
                        schedule.status === 'cancelled' ? 'bg-gray-100 text-gray-700' :
                        'bg-blue-100 text-blue-700'
                      }>
                        {schedule.status === 'completed' ? 'ÂÆå‰∫Ü' :
                         schedule.status === 'in_progress' ? 'ÈÄ≤Ë°å‰∏≠' :
                         schedule.status === 'cancelled' ? '„Ç≠„É£„É≥„Çª„É´' :
                         '‰∫àÂÆö'}
                      </Badge>
                      <div className="flex gap-2">
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => openScheduleDetails(schedule)}
                        >
                          Ë©≥Á¥∞
                        </Button>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => openEditSchedule(schedule)}
                        >
                          Á∑®ÈõÜ
                        </Button>
                      </div>
                    </div>
                  </div>
                );
              })}
          </div>
        </div>
      </Card>

      {/* „Çπ„Ç±„Ç∏„É•„Éº„É´Ë©≥Á¥∞Ë°®Á§∫„ÉÄ„Ç§„Ç¢„É≠„Ç∞ */}
      <Dialog open={isScheduleDetailsOpen} onOpenChange={setIsScheduleDetailsOpen}>
        <DialogContent className="sm:max-w-[600px]">
          <DialogHeader>
            <DialogTitle>„Çπ„Ç±„Ç∏„É•„Éº„É´Ë©≥Á¥∞</DialogTitle>
          </DialogHeader>
          {selectedSchedule && (
            <div className="grid gap-4 py-4">
              <div className="grid grid-cols-2 gap-4">
                <div className="grid gap-2">
                  <Label htmlFor="detail-title">„Çø„Ç§„Éà„É´</Label>
                  <Input
                    id="detail-title"
                    value={selectedSchedule.title}
                    readOnly
                    className="bg-gray-50"
                  />
                </div>
                <div className="grid gap-2">
                  <Label htmlFor="detail-engineer">ÊãÖÂΩì„Ç®„É≥„Ç∏„Éã„Ç¢</Label>
                  <Input
                    id="detail-engineer"
                    value={selectedSchedule.engineerName || firebaseEngineers.find(e => e.id === selectedSchedule.engineerId)?.name || ''}
                    readOnly
                    className="bg-gray-50"
                  />
                </div>
              </div>
              
              <div className="grid gap-2">
                <Label htmlFor="detail-description">Ë©≥Á¥∞</Label>
                <Textarea
                  id="detail-description"
                  value={selectedSchedule.description}
                  readOnly
                  className="bg-gray-50"
                  rows={3}
                />
              </div>
              
              <div className="grid grid-cols-2 gap-4">
                <div className="grid gap-2">
                  <Label htmlFor="detail-start-time">ÈñãÂßãÊôÇÈñì</Label>
                  <Input
                    id="detail-start-time"
                    value={new Date(selectedSchedule.startDate).toLocaleString('ja-JP', {
                      year: 'numeric',
                      month: '2-digit',
                      day: '2-digit',
                      hour: '2-digit',
                      minute: '2-digit'
                    })}
                    readOnly
                    className="bg-gray-50"
                  />
                </div>
                <div className="grid gap-2">
                  <Label htmlFor="detail-end-time">ÁµÇ‰∫ÜÊôÇÈñì</Label>
                  <Input
                    id="detail-end-time"
                    value={new Date(selectedSchedule.endDate).toLocaleString('ja-JP', {
                      year: 'numeric',
                      month: '2-digit',
                      day: '2-digit',
                      hour: '2-digit',
                      minute: '2-digit'
                    })}
                    readOnly
                    className="bg-gray-50"
                  />
                </div>
              </div>
              
              <div className="grid grid-cols-2 gap-4">
                <div className="grid gap-2">
                  <Label htmlFor="detail-duration">‰∫àÊÉ≥ÊôÇÈñì</Label>
                  <Input
                    id="detail-duration"
                    value={selectedSchedule.estimatedDuration ? `${selectedSchedule.estimatedDuration}ÂàÜ` : 'Êú™Ë®≠ÂÆö'}
                    readOnly
                    className="bg-gray-50"
                  />
                </div>
                <div className="grid gap-2">
                  <Label htmlFor="detail-location">Â†¥ÊâÄ</Label>
                  <Input
                    id="detail-location"
                    value={selectedSchedule.location || 'Êú™Ë®≠ÂÆö'}
                    readOnly
                    className="bg-gray-50"
                  />
                </div>
              </div>
              
              <div className="grid grid-cols-2 gap-4">
                <div className="grid gap-2">
                  <Label htmlFor="detail-customer-name">È°ßÂÆ¢Âêç</Label>
                  <Input
                    id="detail-customer-name"
                    value={selectedSchedule.customerName || 'Êú™Ë®≠ÂÆö'}
                    readOnly
                    className="bg-gray-50"
                  />
                </div>
                <div className="grid gap-2">
                  <Label htmlFor="detail-customer-phone">È°ßÂÆ¢ÈõªË©±</Label>
                  <Input
                    id="detail-customer-phone"
                    value={selectedSchedule.customerPhone || 'Êú™Ë®≠ÂÆö'}
                    readOnly
                    className="bg-gray-50"
                  />
                </div>
              </div>
              
              <div className="grid grid-cols-2 gap-4">
                <div className="grid gap-2">
                  <Label htmlFor="detail-priority">ÂÑ™ÂÖàÂ∫¶</Label>
                  <Input
                    id="detail-priority"
                    value={selectedSchedule.priority === 'urgent' ? 'Á∑äÊÄ•' : 
                           selectedSchedule.priority === 'high' ? 'È´ò' :
                           selectedSchedule.priority === 'medium' ? '‰∏≠' : '‰Ωé'}
                    readOnly
                    className="bg-gray-50"
                  />
                </div>
                <div className="grid gap-2">
                  <Label htmlFor="detail-status">„Çπ„ÉÜ„Éº„Çø„Çπ</Label>
                  <Input
                    id="detail-status"
                    value={selectedSchedule.status === 'scheduled' ? '‰∫àÂÆö' :
                           selectedSchedule.status === 'in_progress' ? 'ÈÄ≤Ë°å‰∏≠' :
                           selectedSchedule.status === 'completed' ? 'ÂÆå‰∫Ü' : '„Ç≠„É£„É≥„Çª„É´'}
                    readOnly
                    className="bg-gray-50"
                  />
                </div>
              </div>
            </div>
          )}
          <div className="flex justify-end gap-2">
            <Button 
              variant="outline" 
              onClick={() => {
                if (selectedSchedule) {
                  openEditSchedule(selectedSchedule);
                  setIsScheduleDetailsOpen(false);
                }
              }}
            >
              Á∑®ÈõÜ
            </Button>
            <Button onClick={() => setIsScheduleDetailsOpen(false)}>
              Èñâ„Åò„Çã
            </Button>
          </div>
        </DialogContent>
      </Dialog>

      {/* „Çπ„Ç±„Ç∏„É•„Éº„É´Á∑®ÈõÜ„ÉÄ„Ç§„Ç¢„É≠„Ç∞ */}
      <Dialog open={isEditScheduleOpen} onOpenChange={setIsEditScheduleOpen}>
        <DialogContent className="sm:max-w-[600px]">
          <DialogHeader>
            <DialogTitle>„Çπ„Ç±„Ç∏„É•„Éº„É´Á∑®ÈõÜ</DialogTitle>
          </DialogHeader>
          {editSchedule && (
            <div className="grid gap-4 py-4">
              <div className="grid grid-cols-2 gap-4">
                <div className="grid gap-2">
                  <Label htmlFor="edit-title">„Çø„Ç§„Éà„É´</Label>
                  <Input
                    id="edit-title"
                    value={editSchedule.title}
                    onChange={(e) => setEditSchedule({...editSchedule, title: e.target.value})}
                  />
                </div>
                <div className="grid gap-2">
                  <Label htmlFor="edit-engineer">ÊãÖÂΩì„Ç®„É≥„Ç∏„Éã„Ç¢</Label>
                  <Select
                    value={editSchedule.engineerId}
                    onValueChange={(value) => {
                      console.log('üîç „Ç®„É≥„Ç∏„Éã„Ç¢ÈÅ∏Êäû:', { value, firebaseEngineers });
                      const engineer = firebaseEngineers.find(e => e.id === value);
                      console.log('üîç Ë¶ã„Å§„Åã„Å£„Åü„Ç®„É≥„Ç∏„Éã„Ç¢:', engineer);
                      setEditSchedule({
                        ...editSchedule,
                        engineerId: value, // ÊñáÂ≠óÂàóID„Çí„Åù„ÅÆ„Åæ„Åæ‰ΩøÁî®
                        engineerName: engineer?.name || ''
                      });
                    }}
                  >
                    <SelectTrigger>
                      <SelectValue placeholder="„Ç®„É≥„Ç∏„Éã„Ç¢„ÇíÈÅ∏Êäû" />
                    </SelectTrigger>
                    <SelectContent>
                      {firebaseEngineers.map((engineer) => (
                        <SelectItem key={engineer.id} value={engineer.id}>
                          {engineer.name}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>
              </div>
              
              <div className="grid gap-2">
                <Label htmlFor="edit-description">Ë©≥Á¥∞</Label>
                <Textarea
                  id="edit-description"
                  value={editSchedule.description}
                  onChange={(e) => setEditSchedule({...editSchedule, description: e.target.value})}
                  rows={3}
                />
              </div>
              
              <div className="grid grid-cols-2 gap-4">
                <div className="grid gap-2">
                  <Label htmlFor="edit-start-date">ÈñãÂßãÊó•</Label>
                  <Input
                    id="edit-start-date"
                    type="date"
                    value={editSchedule.startDate.split('T')[0]}
                    onChange={(e) => setEditSchedule({...editSchedule, startDate: e.target.value + 'T' + editSchedule.startDate.split('T')[1]})}
                  />
                </div>
                <div className="grid gap-2">
                  <Label htmlFor="edit-end-date">ÁµÇ‰∫ÜÊó•</Label>
                  <Input
                    id="edit-end-date"
                    type="date"
                    value={editSchedule.endDate.split('T')[0]}
                    onChange={(e) => setEditSchedule({...editSchedule, endDate: e.target.value + 'T' + editSchedule.endDate.split('T')[1]})}
                  />
                </div>
              </div>
              
              <div className="grid grid-cols-2 gap-4">
                <div className="grid gap-2">
                  <Label htmlFor="edit-start-time">ÈñãÂßãÊôÇÈñì</Label>
                  <Input
                    id="edit-start-time"
                    type="time"
                    value={editSchedule.startDate.split('T')[1]?.substring(0, 5) || ''}
                    onChange={(e) => setEditSchedule({...editSchedule, startDate: editSchedule.startDate.split('T')[0] + 'T' + e.target.value + ':00.000Z'})}
                  />
                </div>
                <div className="grid gap-2">
                  <Label htmlFor="edit-end-time">ÁµÇ‰∫ÜÊôÇÈñì</Label>
                  <Input
                    id="edit-end-time"
                    type="time"
                    value={editSchedule.endDate.split('T')[1]?.substring(0, 5) || ''}
                    onChange={(e) => setEditSchedule({...editSchedule, endDate: editSchedule.endDate.split('T')[0] + 'T' + e.target.value + ':00.000Z'})}
                  />
                </div>
              </div>
              
              <div className="grid grid-cols-2 gap-4">
                <div className="grid gap-2">
                  <Label htmlFor="edit-location">Â†¥ÊâÄ</Label>
                  <Input
                    id="edit-location"
                    value={editSchedule.location || ''}
                    onChange={(e) => setEditSchedule({...editSchedule, location: e.target.value})}
                  />
                </div>
                <div className="grid gap-2">
                  <Label htmlFor="edit-status">„Çπ„ÉÜ„Éº„Çø„Çπ</Label>
                  <Select
                    value={editSchedule.status}
                    onValueChange={(value) => setEditSchedule({...editSchedule, status: value as 'scheduled' | 'in_progress' | 'completed' | 'cancelled'})}
                  >
                    <SelectTrigger>
                      <SelectValue placeholder="„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÈÅ∏Êäû" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="scheduled">‰∫àÂÆö</SelectItem>
                      <SelectItem value="in_progress">ÈÄ≤Ë°å‰∏≠</SelectItem>
                      <SelectItem value="completed">ÂÆå‰∫Ü</SelectItem>
                      <SelectItem value="cancelled">„Ç≠„É£„É≥„Çª„É´</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
              </div>
            </div>
          )}
          <div className="flex justify-end gap-2">
            <Button variant="outline" onClick={() => setIsEditScheduleOpen(false)}>
              „Ç≠„É£„É≥„Çª„É´
            </Button>
            <Button onClick={handleUpdateSchedule}>
              Êõ¥Êñ∞
            </Button>
          </div>
        </DialogContent>
      </Dialog>

    </div>
  );
}
